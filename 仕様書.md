# TimeDonut - 仕様書

## 文書情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | TimeDonut |
| 文書バージョン | 1.0 |
| 最終更新日 | 2025-10-26 |
| 作成者 | Claude Code |
| 関連文書 | 要件定義書.md, 設計書.md |

---

## 1. システム概要

### 1.1 システム構成

```
┌─────────────────────────────────────┐
│         macOSメニューバー           │
│    ┌───────────────────────┐        │
│    │  TimeDonut (常駐)     │        │
│    └───────────────────────┘        │
└─────────────────────────────────────┘
              ↓ ↑
┌─────────────────────────────────────┐
│      TimeDonut Application          │
│  ┌─────────────────────────────┐   │
│  │   認証・API連携・UI制御     │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
              ↓ ↑
┌─────────────────────────────────────┐
│   Google Calendar API (REST API)    │
└─────────────────────────────────────┘
```

### 1.2 技術スタック

- **言語**: Swift 5.9+
- **UIフレームワーク**: SwiftUI
- **最小対応OS**: macOS 13 Ventura
- **依存ライブラリ**:
  - GoogleSignIn (OAuth認証)
  - GoogleAPIClientForREST/Calendar (Calendar API)

---

## 2. 機能仕様

### 2.1 Google認証機能

#### 2.1.1 初回サインイン

**画面遷移:**
```
起動
 ↓
認証状態確認 (Keychain)
 ↓
未認証
 ↓
サインイン画面表示
 ↓ (ユーザー操作)
Google OAuth画面 (ブラウザ)
 ↓
認証成功
 ↓
トークン保存 (Keychain)
 ↓
メイン画面
```

**仕様詳細:**

| 項目 | 仕様 |
|------|------|
| 認証方式 | OAuth 2.0 |
| スコープ | `https://www.googleapis.com/auth/calendar.readonly` |
| トークン保存先 | macOS Keychain |
| トークン有効期限 | 1時間（自動リフレッシュ） |
| リフレッシュトークン | Keychainに永続保存 |

**エラーハンドリング:**

| エラー | 対応 |
|--------|------|
| ユーザーキャンセル | サインイン画面に戻る |
| ネットワークエラー | エラーメッセージ表示、リトライボタン |
| 権限拒否 | 権限必要性の説明表示 |

#### 2.1.2 自動サインイン

起動時にKeychainからトークン取得し、有効性確認後に自動サインイン。

#### 2.1.3 サインアウト

- Keychainからトークン削除
- メモリ上のデータクリア
- サインイン画面へ遷移

---

### 2.2 メニューバー表示機能

#### 2.2.1 表示内容

**基本表示:**
```
[⏰ 45分後]
```

**表示パターン:**

| 状態 | 表示 |
|------|------|
| 次の予定が1時間未満 | `⏰ XX分後` |
| 次の予定が1時間以上 | `⏰ X時間XX分後` |
| 次の予定が進行中 | `⏰ 開催中` |
| 予定なし | `⏰ 予定なし` |
| 読み込み中 | `⏰ ...` |
| エラー | `⏰ エラー` |

#### 2.2.2 更新頻度

| 項目 | 頻度 |
|------|------|
| カウントダウン表示 | 1秒ごと |
| カレンダーデータ取得 | 5分ごと |
| 手動更新 | ポップオーバー表示時 |

#### 2.2.3 インタラクション

- **クリック**: ポップオーバー表示
- **右クリック**: コンテキストメニュー
  - 更新
  - 設定
  - サインアウト
  - 終了

---

### 2.3 カレンダーデータ取得機能

#### 2.3.1 取得範囲

- **期間**: 今日の0:00 〜 明日の23:59
- **カレンダー**: ユーザーがアクセス可能な全カレンダー
- **ソート**: 開始時刻の昇順

#### 2.3.2 取得データ

```json
{
  "id": "event_id",
  "summary": "会議",
  "start": {
    "dateTime": "2025-10-26T14:00:00+09:00"
  },
  "end": {
    "dateTime": "2025-10-26T15:00:00+09:00"
  },
  "colorId": "1",
  "status": "confirmed"
}
```

**取得項目:**
- イベントID
- タイトル
- 開始時刻
- 終了時刻
- カラーID
- ステータス

#### 2.3.3 フィルタリング

**除外条件:**
- ステータスが`cancelled`
- 終日イベント（オプション）
- 辞退済みイベント

#### 2.3.4 キャッシュ

- メモリキャッシュ: 最新取得データを保持
- ネットワーク切断時: キャッシュデータで動作継続
- キャッシュ有効期限: 5分

---

### 2.4 ポップオーバー表示機能

#### 2.4.1 レイアウト

```
┌────────────────────────────────┐
│  user@gmail.com       [×]      │ ← ヘッダー (40px)
├────────────────────────────────┤
│                                │
│          ┌────────┐            │
│          │        │            │
│          │  時計  │            │ ← 時計表示 (300x300px)
│          │        │            │
│          └────────┘            │
│                                │
├────────────────────────────────┤
│  📅 今日の予定                 │
│  ┌──────────────────────────┐ │
│  │ 14:00 会議 (1時間)       │ │
│  │ 16:30 打ち合わせ (30分)  │ │ ← 予定リスト (最大200px)
│  │ 18:00 夕食 (1時間)       │ │
│  └──────────────────────────┘ │
├────────────────────────────────┤
│  [更新] [設定] [サインアウト]  │ ← フッター (40px)
└────────────────────────────────┘
```

**サイズ:**
- 幅: 360px (固定)
- 高さ: 500px〜700px (予定数に応じて可変)

#### 2.4.2 アナログ時計 + ドーナツグラフ

**時計仕様:**
```
        12
         |
    9 ── ● ── 3    ← 現在時刻の針
         |
         6
```

- 12時間表示
- 時針・分針・秒針
- 中央に現在時刻をデジタル表示（例: 14:30）

**ドーナツグラフ仕様:**

```
外周に予定を配置:

     12
      ━     ← 12:00-13:00 ランチ (青)
   ━     ━
  ━       ━

  ━       ━━  ← 14:00-15:00 会議 (赤)
   ━     ━━
      ━━

```

- 時計の外周に予定を円弧で表示
- 予定の開始時刻・終了時刻に応じた角度で配置
- 12時位置 = 12:00
- 角度計算: `(時刻 % 12) / 12 * 360度`

**色分けルール:**

| カラーID | 色 |
|----------|-----|
| 1 | ラベンダー |
| 2 | セージ |
| 3 | グレープ |
| 4 | フラミンゴ |
| 5 | バナナ |
| 6 | タンジェリン |
| 7 | ピーコック |
| 8 | グラファイト |
| 9 | ブルーベリー |
| 10 | バジル |
| 11 | トマト |

カラーIDがない場合: デフォルトブルー

**インタラクション:**
- ドーナツセグメントにホバー: 予定詳細ツールチップ表示
- クリック: （将来拡張）予定詳細表示

#### 2.4.3 予定リスト

**表示形式:**

```
📅 今日の予定

14:00  会議                        1時間
       └ 開催中 / あと30分

16:30  打ち合わせ                  30分
       └ 2時間後

18:00  夕食                        1時間
       └ 3時間30分後
```

**仕様:**

| 項目 | 仕様 |
|------|------|
| 最大表示件数 | 10件 |
| ソート順 | 開始時刻昇順 |
| 開催中の予定 | ハイライト表示 |
| 過去の予定 | グレーアウト表示 |

---

### 2.5 常駐機能

#### 2.5.1 起動設定

**Info.plist設定:**
```xml
<key>LSUIElement</key>
<true/>
```
- Dockに表示しない
- ⌘+Tabのアプリスイッチャーに表示しない

#### 2.5.2 自動起動

- macOS「ログイン項目」に登録（ユーザー選択式）
- 設定画面でオン/オフ切り替え可能

#### 2.5.3 バックグラウンド処理

**タイマー処理:**

| 処理 | 間隔 | 優先度 |
|------|------|--------|
| カウントダウン更新 | 1秒 | 高 |
| カレンダー同期 | 5分 | 中 |
| トークンリフレッシュ | 自動（期限前） | 高 |

**メモリ管理:**
- アイドル時のメモリ解放
- 画像・ビューのキャッシュクリア

---

## 3. データ仕様

### 3.1 CalendarEvent モデル

```swift
struct CalendarEvent: Identifiable, Codable {
    let id: String
    let summary: String
    let startTime: Date
    let endTime: Date
    let colorId: String?
    let isAllDay: Bool
    let status: EventStatus

    var duration: TimeInterval {
        endTime.timeIntervalSince(startTime)
    }

    var isOngoing: Bool {
        Date() >= startTime && Date() < endTime
    }
}

enum EventStatus: String, Codable {
    case confirmed
    case tentative
    case cancelled
}
```

### 3.2 AuthState モデル

```swift
struct AuthState: Codable {
    var isAuthenticated: Bool
    var userEmail: String?
    var tokenExpirationDate: Date?
}
```

### 3.3 Keychain保存データ

| キー | 値 | 型 |
|------|----|----|
| `timedonut.accessToken` | アクセストークン | String |
| `timedonut.refreshToken` | リフレッシュトークン | String |
| `timedonut.userEmail` | ユーザーメールアドレス | String |

---

## 4. UI/UX仕様

### 4.1 デザインシステム

#### 4.1.1 カラーパレット

```
プライマリ:    #007AFF (システムブルー)
セカンダリ:    #5856D6 (システムパープル)
背景:          #FFFFFF (ライト) / #1C1C1E (ダーク)
テキスト:      #000000 (ライト) / #FFFFFF (ダーク)
グレー:        #8E8E93
成功:          #34C759
エラー:        #FF3B30
警告:          #FF9500
```

#### 4.1.2 タイポグラフィ

| 用途 | フォント | サイズ |
|------|----------|--------|
| メニューバー | SF Pro | 13pt |
| ヘッダー | SF Pro Bold | 16pt |
| 本文 | SF Pro | 14pt |
| キャプション | SF Pro | 12pt |
| 時計デジタル表示 | SF Mono | 24pt |

#### 4.1.3 スペーシング

- 基本単位: 8px
- 小: 4px
- 中: 8px
- 大: 16px
- 特大: 24px

### 4.2 アニメーション

| 要素 | アニメーション | 時間 |
|------|---------------|------|
| ポップオーバー表示 | フェードイン + スケール | 0.2秒 |
| ポップオーバー非表示 | フェードアウト | 0.15秒 |
| リスト項目 | スライドイン | 0.3秒 |
| 時計の針 | スムーズ回転 | 1秒 |

### 4.3 アクセシビリティ

- VoiceOver対応
- キーボードナビゲーション対応
- ハイコントラストモード対応
- 最小タップエリア: 44x44pt

---

## 5. API仕様

### 5.1 Google Calendar API

#### 5.1.1 エンドポイント

**イベント一覧取得:**
```
GET https://www.googleapis.com/calendar/v3/calendars/primary/events
```

**パラメータ:**
```
timeMin: 2025-10-26T00:00:00+09:00
timeMax: 2025-10-27T23:59:59+09:00
singleEvents: true
orderBy: startTime
maxResults: 50
```

**レスポンス例:**
```json
{
  "items": [
    {
      "id": "abc123",
      "summary": "会議",
      "start": {
        "dateTime": "2025-10-26T14:00:00+09:00"
      },
      "end": {
        "dateTime": "2025-10-26T15:00:00+09:00"
      }
    }
  ]
}
```

#### 5.1.2 エラーコード処理

| ステータスコード | 意味 | 対応 |
|----------------|------|------|
| 401 | 認証エラー | トークンリフレッシュ |
| 403 | 権限不足 | 再認証促す |
| 429 | レート制限 | 指数バックオフでリトライ |
| 500 | サーバーエラー | キャッシュデータ使用 |

---

## 6. セキュリティ仕様

### 6.1 認証情報管理

- アクセストークン: Keychainで暗号化保存
- リフレッシュトークン: Keychainで暗号化保存
- メモリ上のトークン: アプリ終了時にクリア

### 6.2 通信セキュリティ

- すべての通信はHTTPS
- 証明書検証を実施
- タイムアウト: 30秒

### 6.3 プライバシー

- カレンダーデータはローカルメモリのみに保存
- ディスクへの永続化なし（キャッシュ除く）
- アプリ終了時にメモリクリア

---

## 7. パフォーマンス仕様

### 7.1 リソース使用量

| 項目 | 目標値 |
|------|--------|
| メモリ使用量 | 50MB以下 |
| CPU使用率（平常時） | 1%以下 |
| CPU使用率（更新時） | 5%以下 |
| バッテリー消費 | 1日1%以下 |

### 7.2 応答時間

| 操作 | 目標時間 |
|------|----------|
| ポップオーバー表示 | 100ms以下 |
| カレンダーデータ取得 | 5秒以内 |
| UI更新 | 16ms以下（60fps） |

---

## 8. エラー仕様

### 8.1 エラーメッセージ

| エラー | メッセージ | アクション |
|--------|------------|------------|
| ネットワークエラー | "インターネット接続を確認してください" | [再試行] |
| 認証エラー | "再度サインインしてください" | [サインイン] |
| API制限 | "しばらく待ってから再試行してください" | [OK] |
| 不明なエラー | "エラーが発生しました" | [OK] |

### 8.2 ログ出力

**ログレベル:**
- DEBUG: 開発時のみ
- INFO: 通常動作ログ
- WARNING: 警告（処理は継続）
- ERROR: エラー（処理中断）

**ログ出力先:**
- 開発時: Xcodeコンソール
- リリース時: macOS Console.app

---

## 9. テスト仕様

### 9.1 単体テスト

- カバレッジ目標: 80%以上
- モデル層: 100%
- ビジネスロジック: 90%以上

### 9.2 UIテスト

- 主要フロー（サインイン〜表示）の自動テスト
- スクリーンショットテスト

### 9.3 パフォーマンステスト

- メモリリークチェック
- 長時間稼働テスト（24時間）
- API呼び出し頻度チェック

---

## 10. リリース仕様

### 10.1 配布方法

**Phase 1:**
- GitHub Releasesで配布
- .dmg形式

**Phase 2（将来）:**
- Mac App Store申請

### 10.2 更新通知

- アプリ内で新バージョン通知
- GitHub APIで最新バージョン確認

---

## 11. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 1.0 | 2025-10-26 | 初版作成 |

---

**承認欄**

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトオーナー | - | 2025-10-26 | - |
